#!/bin/bash
set -eu
trap _error ERR

_error() {
	echo "runtime error... :("
	exit 1
}

ME="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
WYGA_VERSION=$(basename "${ME}")

cd "${ME}"
if [[ ! $WYGA_VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]
then
	echo "sorry... unable to build... wrong working dir"
	exit 1
fi

export WYGA_VERSION

source setup

export REGISTRY
export BASE
export BASE_TAG_AS
export LOCAL_BUILD_EXT
export EXTENSION_TAG_AS
export EXTENSIONS
export EXTENSIONS_CUSTOM

echo "Build for: ${WYGA_VERSION}"
echo "Registry: $REGISTRY"
echo "BASE: $BASE ($BASE_TAG_AS)"
echo "LOCAL_BUILD_EXT: $LOCAL_BUILD_EXT"
echo "Extensions: $EXTENSIONS ($EXTENSION_TAG_AS)"
echo "Custom extensions: $EXTENSIONS_CUSTOM ($EXTENSION_TAG_AS)"

cmd="${1:-none}"
echo "Action: $cmd"

case "$cmd" in
	md)
		if [[ -x ./show ]]
		then
			./show-md
		else
			../show-md
		fi
		;;
	base)
		if [[ -x ./build-base ]]
		then
			./build-base
		else
			../build-base
		fi
		echo "Done"
		;;
	ext)
		if [[ -x ./build-ext ]]
		then
			./build-ext
		else
			../build-ext
		fi
		echo "Done"
		;;
	ext:*)
		_b="${cmd##*:}"
		if [[ -x ./build-ext.${_b} ]]
		then
			./build-ext.${_b}
		else
			../build-ext.${_b}
		fi
		echo "Done"
		;;
	package)
		if [[ -x ./package-ext ]]
		then
			./package-ext
		else
			../package-ext
		fi
		echo "Done"
		;;
	package:*)
		_b="${cmd##*:}"
		if [[ -x ./package-ext.${_b} ]]
		then
			./package-ext.${_b}
		else
			../package-ext.${_b}
		fi
		echo "Done"
		;;
	publish)
		if [[ -x ./package-publish ]]
		then
			./package-publish
		else
			../package-publish
		fi
		echo "Done"
		;;
esac
